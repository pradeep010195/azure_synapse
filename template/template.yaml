parameters:
  - name: azureServiceConnection
    type: string

steps:
- task: AzureCLI@2
  inputs:
    azureSubscription: ${{ parameters.azureServiceConnection }}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: echo "Azure context set to ${{ parameters.azureServiceConnection }}"
  displayName: 'Switch to ${{ parameters.azureServiceConnection }}'
  
- script: |
      export ARM_CLIENT_ID=$(az account show --query="id" -o tsv)
      export ARM_TENANT_ID=$(az account show --query="tenantId" -o tsv)
      export ARM_SUBSCRIPTION_ID=$(az account show --query="id" -o tsv)

- script: terraform init
  displayName: 'Terraform Init for ${{ parameters.azureServiceConnection }}'

- script: terraform plan
  displayName: 'Terraform Plan for ${{ parameters.azureServiceConnection }}'

# - script: terraform apply -auto-approve
#   displayName: 'Terraform Apply for ${{ parameters.azureServiceConnection }}'
