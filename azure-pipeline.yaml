trigger:
  - main

parameters:
  - name: tfAction
    displayName: Terraform Action
    type: string
    default: apply
    values:
      - apply
      - destroy
  - name: azureServiceConnection
    displayName: Azure Service Connection
    type: string
    default: 'practice connection 1'  # You can set a default value or remove this line if there's none

pool:
  vmImage: 'ubuntu-latest'

jobs:
  - job: TerraformOnMultipleSubscriptions
    steps:
      - checkout: self

      - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
        inputs:
          terraformVersion: '0.14.0'

      - script: |
          terraform init
        displayName: 'Terraform Init'

      - script: |
          terraform plan
        displayName: 'Terraform Plan'

      - script: |
          terraform apply -auto-approve
        displayName: 'Terraform Apply'
        condition: eq(parameters.tfAction, 'apply')

      - script: |
          terraform destroy -auto-approve
        displayName: 'Terraform Destroy'
        condition: eq(parameters.tfAction, 'destroy')

      - template: template/template.yaml
        parameters:
          azureServiceConnection: ${{ parameters.azureServiceConnection }}